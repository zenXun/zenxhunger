---
const { currentLocale, url } = Astro;
const locales = ['en', 'zh'];

// Replace the current locale prefix with the new one
function getTranslatedUrl(locale: string): string {
  const pathParts = url.pathname.split('/').filter(part => part);
  if (pathParts.length > 0 && locales.includes(pathParts[0])) {
    pathParts[0] = locale;
  } else {
    // If no locale prefix is present (e.g., at the root), add it.
    pathParts.unshift(locale);
  }
  return `/${pathParts.join('/')}`;
}

const flags: { [key: string]: string } = {
  en: `
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 72 48">
      <path fill="#fff" d="M0 0h72v48H0z"/>
      <path fill="#b22234" d="M0 4v8h72V4zM0 20v8h72v-8zM0 36v8h72v-8z"/>
      <path fill="#3c3b6e" d="M0 0h36v24H0z"/>
      <g fill="#fff">
        <path d="M6 4l1.3 4H12l-3.3 2.5 1.3 4L6 12l-3.3 2.5 1.3-4L.7 8H6zM18 4l1.3 4H24l-3.3 2.5 1.3 4-4-2.5-4 2.5 1.3-4L12.7 8H18zM30 4l1.3 4H36l-3.3 2.5 1.3 4-4-2.5-4 2.5 1.3-4L24.7 8H30zM12 12l1.3 4H18l-3.3 2.5 1.3 4-4-2.5-4 2.5 1.3-4L6.7 16H12zM24 12l1.3 4H30l-3.3 2.5 1.3 4-4-2.5-4 2.5 1.3-4L18.7 16H24z"/>
      </g>
    </svg>
  `,
  zh: `
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 72 48">
      <path fill="#de2910" d="M0 0h72v48H0z"/>
      <path fill="#ffde00" d="M14.4 9.6L12 16l-4.8-1.2 2.5 4.3-4.1 3 5 .2L9.4 27l3.8-3.4 1.2 4.8L18 24l-4.3-2.5 3-4.1-.2-5-3.4 3.8zM28 3l-.6 2.3-2.3.5.3 2.3L23 7.8l2 1.3-1.6 2 2.3-.2 1.3 2L28 11l-1-2.2 2.1-1.3L27.8 5l2.2.3zM33.6 7.2l-1.8 1.5 1.8 1.5-.2-2.3.2-2.2zM32.2 13.8l-2.3.5.3 2.3-2.3-.5L26 15.8l2 1.2-1.6 2 2.3-.2 1.3 2L30.8 19l-1-2.2 2-1.3-1.3-2.1 2.1.2zM28 19.8l-.6 2.3-2.3.5.3 2.3-2.3-.3 2 1.3-1.6 2 2.3-.2 1.3 2L28 23l-1-2.2 2.1-1.3L27.8 17l2.2.3z"/>
    </svg>
  `
}
---

<div class="relative" x-data="{ open: false }" @click.away="open = false">
  <button @click="open = !open" class="w-8 h-8 rounded-full overflow-hidden focus:outline-none focus:ring-2 focus:ring-emerald-600">
    <Fragment set:html={flags[currentLocale]} />
  </button>

  <div
    x-show="open"
    x-transition
    class="absolute right-0 mt-2 w-40 bg-white dark:bg-stone-800 rounded-lg shadow-lg border border-stone-200/80 dark:border-stone-700/80 overflow-hidden"
  >
    <ul class="py-1">
      {locales.map(locale => (
        <li>
          <a
            href={getTranslatedUrl(locale)}
            class:list={[
              "flex items-center gap-3 px-4 py-2 text-sm",
              {
                "bg-stone-100 dark:bg-stone-700 font-semibold text-stone-900 dark:text-stone-100": locale === currentLocale,
                "text-stone-600 dark:text-stone-300 hover:bg-stone-100/50 dark:hover:bg-stone-700/50": locale !== currentLocale
              }
            ]}
          >
            <div class="w-6 h-4" set:html={flags[locale]}></div>
            <span>{locale.toUpperCase()}</span>
          </a>
        </li>
      ))}
    </ul>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
