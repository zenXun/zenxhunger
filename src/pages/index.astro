---
import BaseLayout from "@/layouts/BaseLayout.astro";
import { getCollection } from "astro:content";
import { getTranslations } from "@/i18n/translations";
import { statusColors } from "@/utils/status";

const { currentLocale } = Astro;
const t = getTranslations(currentLocale as "en" | "zh");

const filterPost = (post: any) =>
  post.data.locale === currentLocale &&
  (import.meta.env.PROD ? !post.data.draft : true);

const sortPost = (a: any, b: any) =>
  b.data.pubDate.valueOf() - a.data.pubDate.valueOf();

const rawStudio = (await getCollection("studio")).filter(filterPost);
const rawLibrary = (await getCollection("library")).filter(filterPost);
const rawCafe = (await getCollection("cafe")).filter(filterPost);
const rawClub = (await getCollection("club")).filter(filterPost);

const allPosts = [...rawStudio, ...rawLibrary, ...rawCafe, ...rawClub].sort(
  sortPost,
);
const latestPosts = allPosts.slice(0, 6);

const studioPosts = rawStudio.sort(sortPost).slice(0, 5);
const libraryPosts = rawLibrary.sort(sortPost).slice(0, 5);
const cafePosts = rawCafe.sort(sortPost).slice(0, 5);
const clubPosts = rawClub.sort(sortPost).slice(0, 5);
---

<BaseLayout>
  <section class="max-w-5xl mx-auto px-6 sm:px-8 lg:px-12 py-20 sm:py-32">
    <div class="text-center space-y-8">
      <div class="space-y-4">
        <h1
          class="font-serif text-5xl sm:text-6xl lg:text-7xl font-semibold tracking-tight text-primary leading-tight"
        >
          Zen X Hunger
        </h1>
        <p class="text-2xl sm:text-3xl text-secondary font-light tracking-wide">
          思考 · 探索 · 品味
        </p>
      </div>
    </div>
  </section>

  <!-- Latest Stream Section -->
  <section
    class="max-w-7xl mx-auto px-6 sm:px-8 lg:px-12 py-16 border-b border-border-subtle/40"
  >
    <h2
      class="text-3xl sm:text-4xl font-semibold text-primary mb-12 tracking-tight"
    >
      {t["home.latest"]}
    </h2>

    {
      latestPosts.length > 0 ? (
        <div class="grid gap-8 md:grid-cols-2 lg:grid-cols-3">
          {latestPosts.map((post) => (
            <article class="group bg-surface rounded-xl border border-border-subtle p-7 hover:shadow-xl hover:shadow-stone-200/50 dark:hover:shadow-stone-900/50 hover:border-border-subtle hover:-translate-y-1 transition-all duration-300 relative overflow-hidden">
              {/* Collection Badge */}
              <div class="absolute top-0 right-0 p-4 opacity-5 group-hover:opacity-10 transition-opacity pointer-events-none">
                <span class="text-6xl font-serif font-black uppercase text-secondary">
                  {post.collection[0]}
                </span>
              </div>

              <div class="flex items-center gap-2.5 mb-4 relative z-10">
                <span
                  class={`text-xs font-medium px-3 py-1 rounded-full ${statusColors[post.data.status]}`}
                >
                  {post.data.status}
                </span>
                <span class="text-xs font-medium px-2 py-0.5 rounded border border-border-subtle text-secondary uppercase tracking-wider">
                  {t[`nav.${post.collection}`]}
                </span>
                <time class="text-xs text-secondary font-light ml-auto">
                  {post.data.pubDate.toLocaleDateString(currentLocale, {
                    year: "numeric",
                    month: "short",
                    day: "numeric",
                  })}
                </time>
              </div>
              <h4 class="text-xl font-semibold text-primary mb-3 line-clamp-2 group-hover:text-accent transition-colors duration-200 relative z-10">
                <a href={`/${post.collection}/${post.slug.split("/").pop()}`}>
                  {post.data.title}
                </a>
              </h4>
              <p class="text-sm text-secondary leading-relaxed mb-5 line-clamp-3 font-light relative z-10">
                {post.data.description}
              </p>
              <div class="flex flex-wrap gap-2 relative z-10">
                {post.data.tags.slice(0, 3).map((tag) => (
                  <span class="text-xs text-secondary bg-muted px-2.5 py-1 rounded-md font-light">
                    #{tag}
                  </span>
                ))}
              </div>
            </article>
          ))}
        </div>
      ) : (
        <p class="text-stone-500 dark:text-stone-400 italic font-light">
          {t["noPosts"]}
        </p>
      )
    }

    <div class="w-24 h-1 bg-accent/20 rounded-full mx-auto mt-20"></div>
  </section>

  <!-- Collections Grid Section -->
  <section
    class="max-w-7xl mx-auto px-6 sm:px-8 lg:px-12 py-16 opacity-90 hover:opacity-100 transition-opacity duration-500"
  >
    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-12 gap-y-16 lg:gap-x-24">
      {/* Studio Column */}
      <div class="flex flex-col gap-6">
        <div
          class="flex items-center justify-between border-b border-border-subtle/60 pb-3"
        >
          <h3
            class="text-2xl font-semibold text-stone-800 dark:text-stone-200 tracking-tight"
          >
            {t["nav.studio"]}
          </h3>
          <a
            href="/studio"
            class="text-sm font-medium text-stone-500 dark:text-stone-400 hover:text-accent transition-all duration-200 flex items-center gap-1 group"
          >
            {t["viewAll"]}
            <svg
              class="w-4 h-4 transform group-hover:translate-x-1 transition-transform duration-200"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 5l7 7-7 7"></path>
            </svg>
          </a>
        </div>
        <p class="text-sm text-stone-500 dark:text-stone-400 font-light -mt-2">
          {t["studio.description"]}
        </p>

        {
          studioPosts.length > 0 ? (
            <ul class="space-y-5">
              {studioPosts.map((post) => (
                <li class="group">
                  <a
                    href={`/studio/${post.slug.split("/").pop()}`}
                    class="flex items-baseline justify-between gap-4"
                  >
                    <span class="text-base font-medium text-primary group-hover:text-accent transition-colors line-clamp-1">
                      {post.data.title}
                    </span>
                    <time class="text-xs text-secondary/60 font-mono whitespace-nowrap shrink-0">
                      {post.data.pubDate.toLocaleDateString(currentLocale, {
                        month: "numeric",
                        day: "numeric",
                      })}
                    </time>
                  </a>
                </li>
              ))}
            </ul>
          ) : (
            <p class="text-stone-500 dark:text-stone-400 italic font-light text-sm">
              {t["studio.noPosts"]}
            </p>
          )
        }
      </div>

      {/* Library Column */}
      <div class="flex flex-col gap-6">
        <div
          class="flex items-center justify-between border-b border-border-subtle/60 pb-3"
        >
          <h3
            class="text-2xl font-semibold text-stone-800 dark:text-stone-200 tracking-tight"
          >
            {t["nav.library"]}
          </h3>
          <a
            href="/library"
            class="text-sm font-medium text-stone-500 dark:text-stone-400 hover:text-accent transition-all duration-200 flex items-center gap-1 group"
          >
            {t["viewAll"]}
            <svg
              class="w-4 h-4 transform group-hover:translate-x-1 transition-transform duration-200"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 5l7 7-7 7"></path>
            </svg>
          </a>
        </div>
        <p class="text-sm text-stone-500 dark:text-stone-400 font-light -mt-2">
          {t["library.description"]}
        </p>

        {
          libraryPosts.length > 0 ? (
            <ul class="space-y-5">
              {libraryPosts.map((post) => (
                <li class="group">
                  <a
                    href={`/library/${post.slug.split("/").pop()}`}
                    class="flex items-baseline justify-between gap-4"
                  >
                    <span class="text-base font-medium text-primary group-hover:text-accent transition-colors line-clamp-1">
                      {post.data.title}
                    </span>
                    <time class="text-xs text-secondary/60 font-mono whitespace-nowrap shrink-0">
                      {post.data.pubDate.toLocaleDateString(currentLocale, {
                        month: "numeric",
                        day: "numeric",
                      })}
                    </time>
                  </a>
                </li>
              ))}
            </ul>
          ) : (
            <p class="text-stone-500 dark:text-stone-400 italic font-light text-sm">
              {t["library.noPosts"]}
            </p>
          )
        }
      </div>

      {/* Cafe Column */}
      <div class="flex flex-col gap-6">
        <div
          class="flex items-center justify-between border-b border-border-subtle/60 pb-3"
        >
          <h3
            class="text-2xl font-semibold text-stone-800 dark:text-stone-200 tracking-tight"
          >
            {t["nav.cafe"]}
          </h3>
          <a
            href="/cafe"
            class="text-sm font-medium text-stone-500 dark:text-stone-400 hover:text-accent transition-all duration-200 flex items-center gap-1 group"
          >
            {t["viewAll"]}
            <svg
              class="w-4 h-4 transform group-hover:translate-x-1 transition-transform duration-200"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 5l7 7-7 7"></path>
            </svg>
          </a>
        </div>
        <p class="text-sm text-stone-500 dark:text-stone-400 font-light -mt-2">
          {t["cafe.description"]}
        </p>

        {
          cafePosts.length > 0 ? (
            <ul class="space-y-5">
              {cafePosts.map((post) => (
                <li class="group">
                  <a
                    href={`/cafe/${post.slug.split("/").pop()}`}
                    class="flex items-baseline justify-between gap-4"
                  >
                    <span class="text-base font-medium text-primary group-hover:text-accent transition-colors line-clamp-1">
                      {post.data.title}
                    </span>
                    <time class="text-xs text-secondary/60 font-mono whitespace-nowrap shrink-0">
                      {post.data.pubDate.toLocaleDateString(currentLocale, {
                        month: "numeric",
                        day: "numeric",
                      })}
                    </time>
                  </a>
                </li>
              ))}
            </ul>
          ) : (
            <p class="text-stone-500 dark:text-stone-400 italic font-light text-sm">
              {t["cafe.noPosts"]}
            </p>
          )
        }
      </div>

      {/* Club Column */}
      <div class="flex flex-col gap-6">
        <div
          class="flex items-center justify-between border-b border-border-subtle/60 pb-3"
        >
          <h3
            class="text-2xl font-semibold text-stone-800 dark:text-stone-200 tracking-tight"
          >
            {t["nav.club"]}
          </h3>
          <a
            href="/club"
            class="text-sm font-medium text-stone-500 dark:text-stone-400 hover:text-accent transition-all duration-200 flex items-center gap-1 group"
          >
            {t["viewAll"]}
            <svg
              class="w-4 h-4 transform group-hover:translate-x-1 transition-transform duration-200"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 5l7 7-7 7"></path>
            </svg>
          </a>
        </div>
        <p class="text-sm text-stone-500 dark:text-stone-400 font-light -mt-2">
          {t["club.description"]}
        </p>

        {
          clubPosts.length > 0 ? (
            <ul class="space-y-5">
              {clubPosts.map((post) => (
                <li class="group">
                  <a
                    href={`/club/${post.slug.split("/").pop()}`}
                    class="flex items-baseline justify-between gap-4"
                  >
                    <span class="text-base font-medium text-primary group-hover:text-accent transition-colors line-clamp-1">
                      {post.data.title}
                    </span>
                    <time class="text-xs text-secondary/60 font-mono whitespace-nowrap shrink-0">
                      {post.data.pubDate.toLocaleDateString(currentLocale, {
                        month: "numeric",
                        day: "numeric",
                      })}
                    </time>
                  </a>
                </li>
              ))}
            </ul>
          ) : (
            <p class="text-stone-500 dark:text-stone-400 italic font-light text-sm">
              {t["club.noPosts"]}
            </p>
          )
        }
      </div>
    </div>
  </section>
</BaseLayout>
