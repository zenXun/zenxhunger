---
import { type CollectionEntry, getCollection, getEntry } from "astro:content";
import BaseLayout from "@/layouts/BaseLayout.astro";
import Comments from "@/components/Comments.astro";
import ShareButtons from "@/components/ShareButtons.astro";
import { getTranslations } from "@/i18n/translations";

import { statusColors } from "@/utils/status";
export async function getStaticPaths() {
  const posts = await getCollection("studio", ({ data }) => {
    return data.locale === "en" && (import.meta.env.PROD ? !data.draft : true);
  });
  return posts.map((post) => ({
    params: { slug: post.slug.split("/").pop() },
    props: { post },
  }));
}
const { currentLocale } = Astro;
const t = getTranslations(currentLocale as "en" | "zh");
const { slug } = Astro.params;
const { post } = Astro.props;

// Smart Language Switching Logic
const otherLocale = "zh";
const baseSlug = post.slug.split("/").pop();
const otherSlug = `${otherLocale}/${baseSlug}`;
const otherPost = await getEntry("studio", otherSlug);
const isOtherVisible =
  otherPost && (import.meta.env.PROD ? !otherPost.data.draft : true);

const translatedUrls = {
  en: `/en/studio/${baseSlug}`,
  zh: isOtherVisible ? `/studio/${baseSlug}` : `/studio`,
};

const { Content } = await post.render();
---

<BaseLayout
  title={`${post.data.title} - Zen X Hunger`}
  description={post.data.description}
  translatedUrls={translatedUrls}
>
  <article class="max-w-4xl mx-auto px-6 sm:px-8 lg:px-12 py-20">
    <nav class="mb-12 text-sm text-secondary font-light">
      <a href="/en" class="hover:text-accent transition-all duration-200"
        >{t["nav.home"]}</a
      >
      <span class="mx-2 text-secondary/40">/</span>
      <a href="/en/studio" class="hover:text-accent transition-all duration-200"
        >{t["studio.title"]}</a
      >
      <span class="mx-2 text-secondary/40">/</span>
      <span class="text-primary line-clamp-1">{post.data.title}</span>
    </nav>
    <header class="mb-16 space-y-6">
      <div class="flex items-center gap-3">
        <span
          class={`text-xs font-medium px-3 py-1 rounded-full ${statusColors[post.data.status]}`}
        >
          {post.data.status}
        </span>
        <time class="text-sm text-secondary font-light">
          {
            post.data.pubDate.toLocaleDateString(currentLocale, {
              year: "numeric",
              month: "long",
              day: "numeric",
            })
          }
        </time>
      </div>
      <h1
        class="font-serif text-4xl sm:text-5xl lg:text-6xl font-semibold text-primary leading-tight tracking-tight"
      >
        {post.data.title}
      </h1>
      <p class="text-xl text-secondary leading-relaxed font-light">
        {post.data.description}
      </p>
      <div class="w-16 h-px bg-gradient-to-r from-accent/30 to-transparent">
      </div>
      <div class="flex flex-wrap gap-2.5">
        {
          post.data.tags.map((tag) => (
            <span class="text-sm text-secondary bg-muted px-3 py-1.5 rounded-md font-light">
              {" "}
              #{tag}
            </span>
          ))
        }
      </div>
    </header>
    <div
      class="prose mx-auto prose-reading prose-a:text-emerald-700 dark:prose-a:text-emerald-400 hover:prose-a:text-emerald-600 dark:hover:prose-a:text-emerald-300 prose-a:no-underline hover:prose-a:underline"
    >
      <Content />
    </div>
    <ShareButtons title={post.data.title} url={Astro.url} />
    <footer class="mt-20 pt-10 border-t border-border-subtle/60">
      <a
        href="/en/studio"
        class="inline-flex items-center gap-2 text-sm font-medium text-secondary hover:text-accent transition-all duration-200 group"
      >
        <svg
          class="w-4 h-4 transform group-hover:-translate-x-1 transition-transform duration-200"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M15 19l-7-7 7-7"></path>
        </svg>
        {t["backToStudio"]}
      </a>
    </footer>
    <Comments />
  </article>
</BaseLayout>
